name: Downgrade Action

on:
  workflow_dispatch:
    inputs:
      version:
        type: text
        required: true
        description: Version to downgrade to

jobs:
  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.check.outputs.result }}
    steps:
      - name: Chcek
        id: check
        uses: actions/github-script@v6
        with:
          result-encoding: string
          script: |
            const version = '${{ github.event.inputs.version }}';
            if (!/^v20\d{2}(?:\.\d{1,3}){1,2}(?:(?:-alpha\.|-beta\.)\d{1,3})?$/.test(version))
            {
              core.setFailed(`Invalid version "${version}".`);
            }
            else
            {
              return version.includes('-alpha.') ? 'alpha-downgrade' : version.includes('-beta.') ? 'beta-downgrade' : 'production-downgrade';
            }

  downgrade:
    name: Downgrade
    needs: [version-check]
    uses: ./.github/workflows/downgrade.yaml
    with:
      version: ${{ github.event.inputs.version }}
      environment: ${{ needs.version-check.environment }}

  re-deploy:
    name: Re-deploy
    needs: [version-check]
    uses: ./.github/workflows/re-deploy.yaml
    with:
      version: ${{ github.event.inputs.version }}
      environment: ${{ needs.version-check.environment }}
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
      kube_config: ${{ secrets.### }} # TODO: Replace ### with SERVER63_KUBE_CONFIG (for the physical server) or LJN1_KUBE_CONFIG (for the cluster)
